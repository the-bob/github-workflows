name: Terraform CI

on:
  workflow_call:
    inputs:
      name:
        required: false 
    secrets:
      github_token:
        required: false

jobs:
  terraform:    
    runs-on: ubuntu-latest
    environment: development

    defaults:
      run:
        shell: bash

   env:
      GITHUB_TOKEN: ${{ secrets.github_token }}
      
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: 1.1.8
        
    - name: Terraform Init
      run: terraform init

    - name: Terraform Format
      run: terraform fmt -check
    
    - name: Terraform Validate
      run: terraform validate

    - name: Render terraform docs inside the README.md and push changes back to PR branch
      uses: terraform-docs/gh-actions@v1.0.0
      with:
        working-dir: .
        output-file: README.md
        output-method: inject
        git-push: "true"

    - name: Release
      uses: rymndhng/release-on-push-action@master
      with:
        bump_version_scheme: minor


      